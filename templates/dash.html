<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI-DMS: Asia Disaster Insights (2000–2025)</title>
  <!-- React and ReactDOM -->
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <!-- Babel for JSX -->
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.22.9/babel.min.js"></script>
  <!-- Chart.js (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- Chart.js Zoom Plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
  <!-- Tailwind CSS (precompiled) -->
  <link href="https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <!-- Heroicons for theme toggle and icons -->
  <script src="https://unpkg.com/@heroicons/react@2.0.13/outline/sun.js"></script>
  <script src="https://unpkg.com/@heroicons/react@2.0.13/outline/moon.js"></script>
  <!-- External CSS -->
  <link href="{{ url_for('static', filename='css/dash.css') }}" rel="stylesheet">
</head>
<body>
  <div id="root"></div>
  {% raw %}
  <script type="text/babel">
    console.log('Starting script execution');

    const { useState, useEffect, useRef } = React;

    console.log('Scripts loaded: React, ReactDOM, Babel, Chart.js, Chart.js Zoom, Heroicons');

    // Register Chart.js zoom plugin
    Chart.register(ChartZoom);

    // Process data for charts
    const processData = (data, selectedCountry, selectedYear) => {
      try {
        console.log('Processing data, length:', data?.length || 0, 'Country:', selectedCountry || 'All', 'Year:', selectedYear || 'All');

        if (!Array.isArray(data) || data.length === 0) {
          console.error('Invalid or empty data');
          return null;
        }

        let filteredData = data;
        if (selectedCountry && selectedCountry !== 'All') {
          filteredData = filteredData.filter(d => d.Country && d.Country === selectedCountry);
        }
        if (selectedYear && selectedYear !== 'All') {
          filteredData = filteredData.filter(d => d['Start Year'] && d['Start Year'] === parseInt(selectedYear));
        }

        if (filteredData.length === 0) {
          console.warn('No data for selected filters:', selectedCountry, selectedYear);
          return null;
        }

        // Disaster Trends Over Time
        const disastersPerYear = {};
        filteredData.forEach(d => {
          const year = d['Start Year'];
          if (year) disastersPerYear[year] = (disastersPerYear[year] || 0) + 1;
        });

        // Top Disaster Types (with "Other" category)
        const disasterTypes = {};
        filteredData.forEach(d => {
          const type = d['Disaster Type'];
          if (type) disasterTypes[type] = (disasterTypes[type] || 0) + 1;
        });
        const totalDisasters = Object.values(disasterTypes).reduce((sum, count) => sum + count, 0);
        const minPercentage = 0.05;
        const processedDisasterTypes = {};
        let otherCount = 0;
        Object.entries(disasterTypes).forEach(([type, count]) => {
          if (count / totalDisasters >= minPercentage) {
            processedDisasterTypes[type] = count;
          } else {
            otherCount += count;
          }
        });
        if (otherCount > 0) {
          processedDisasterTypes['Other'] = otherCount;
        }
        console.log('Pie chart data:', processedDisasterTypes);

        // Most Affected Locations
        const locations = {};
        filteredData.forEach(d => {
          const loc = d.Country;
          if (loc) locations[loc] = (locations[loc] || 0) + 1;
        });

        // Impact by Disaster Type
        const impactByType = {};
        filteredData.forEach(d => {
          const type = d['Disaster Type'];
          if (type) {
            if (!impactByType[type]) impactByType[type] = { deaths: 0, affected: 0 };
            impactByType[type].deaths += d['Total Deaths'] || 0;
            impactByType[type].affected += d['Total Affected'] || 0;
          }
        });

        // Deadliest Years
        const deathsByYear = {};
        filteredData.forEach(d => {
          const year = d['Start Year'];
          if (year) deathsByYear[year] = (deathsByYear[year] || 0) + (d['Total Deaths'] || 0);
        });

        // Most Destructive Disaster Types
        const damageByType = {};
        filteredData.forEach(d => {
          const type = d['Disaster Type'];
          const damage = d["Total Damage ('000 US$)"] || 0;
          if (type && damage > 0) damageByType[type] = (damageByType[type] || 0) + damage;
        });

        // Seasonality of Disasters
        const disastersPerMonth = Array(12).fill(0);
        filteredData.forEach(d => {
          const month = parseInt(d['Start Month']) - 1;
          if (month >= 0 && month < 12) disastersPerMonth[month]++;
        });

        // Correlation Data
        const correlationData = filteredData.map(d => ({
          x: d['Total Deaths'] || 0,
          y: d["Total Damage ('000 US$)"] || 0
        })).filter(d => d.x > 0 || d.y > 0);

        // Disaster Frequency by Region
        const regions = {};
        filteredData.forEach(d => {
          const region = d.Region || 'Unknown';
          regions[region] = (regions[region] || 0) + 1;
        });

        // Economic Impact by Year
        const damageByYear = {};
        filteredData.forEach(d => {
          const year = d['Start Year'];
          const damage = d["Total Damage ('000 US$)"] || 0;
          if (year && damage > 0) damageByYear[year] = (damageByYear[year] || 0) + damage;
        });

        // Disaster Frequency by Subtype or Top 5 Costliest Disasters
        let subtypes = {};
        let costliestDisasters = [];
        if (filteredData.some(d => d['Disaster Subtype'])) {
          filteredData.forEach(d => {
            const subtype = d['Disaster Subtype'] || 'Unknown';
            subtypes[subtype] = (subtypes[subtype] || 0) + 1;
          });
        } else {
          costliestDisasters = filteredData
            .filter(d => d["Total Damage ('000 US$)"] > 0)
            .map(d => ({
              label: `${d['Disaster Type']} (${d['Start Year']}, ${d.Country})`,
              damage: d["Total Damage ('000 US$)"]
            }))
            .sort((a, b) => b.damage - a.damage)
            .slice(0, 5);
        }
        subtypes = Object.fromEntries(Object.entries(subtypes).sort((a, b) => b[1] - a[1]).slice(0, 10));
        console.log('New chart data:', subtypes, costliestDisasters);

        console.log('Data processed successfully', { disasterTypes: Object.keys(processedDisasterTypes).length, locations: Object.keys(locations).length, regions: Object.keys(regions).length, years: Object.keys(disastersPerYear).length, subtypes: Object.keys(subtypes).length, costliest: costliestDisasters.length });
        return {
          disastersPerYear,
          disasterTypes: processedDisasterTypes,
          locations: Object.fromEntries(Object.entries(locations).sort((a, b) => b[1] - a[1]).slice(0, 10)),
          impactByType,
          deathsByYear: Object.fromEntries(Object.entries(deathsByYear).sort((a, b) => b[1] - a[1]).slice(0, 5)),
          damageByType,
          disastersPerMonth,
          correlationData,
          regions: Object.fromEntries(Object.entries(regions).sort((a, b) => b[1] - a[1]).slice(0, 10)),
          damageByYear,
          subtypes,
          costliestDisasters
        };
      } catch (error) {
        console.error('Error processing data:', error.message, error.stack);
        return null;
      }
    };

    const Dashboard = () => {
      const [data, setData] = useState(null);
      const [rawData, setRawData] = useState(null);
      const [error, setError] = useState(null);
      const [countries, setCountries] = useState([]);
      const [years, setYears] = useState([]);
      const [selectedCountry, setSelectedCountry] = useState('All');
      const [selectedYear, setSelectedYear] = useState('All');
      const [theme, setTheme] = useState(localStorage.getItem('theme') || 'green');
      const [showLabels, setShowLabels] = useState(true);
      const [showTour, setShowTour] = useState(!localStorage.getItem('tourCompleted'));
      const [tourStep, setTourStep] = useState(0);
      const [btnActive, setBtnActive] = useState('');
      const [sidebarOpen, setSidebarOpen] = useState(window.innerWidth >= 768);
      const [currentTime, setCurrentTime] = useState(new Date().toLocaleTimeString());

      // Chart refs
      const trendsChartRef = useRef(null);
      const typesChartRef = useRef(null);
      const locationsChartRef = useRef(null);
      const impactChartRef = useRef(null);
      const deadliestChartRef = useRef(null);
      const damageChartRef = useRef(null);
      const seasonalityChartRef = useRef(null);
      const correlationChartRef = useRef(null);
      const regionsChartRef = useRef(null);
      const damageYearChartRef = useRef(null);
      const subtypesChartRef = useRef(null);

      // Section refs for navigation
      const sections = {
        types: useRef(null),
        trends: useRef(null),
        locations: useRef(null),
        impact: useRef(null),
        deadliest: useRef(null),
        damage: useRef(null),
        seasonality: useRef(null),
        correlation: useRef(null),
        regions: useRef(null),
        damageYear: useRef(null),
        subtypes: useRef(null),
        insights: useRef(null)
      };

      // Update time every second
      useEffect(() => {
        const timer = setInterval(() => {
          setCurrentTime(new Date().toLocaleTimeString());
        }, 1000);
        return () => clearInterval(timer);
      }, []);

      // Ensure sidebar is open on medium screens
      useEffect(() => {
        const handleResize = () => {
          setSidebarOpen(window.innerWidth >= 768);
          console.log('Window resized, sidebarOpen:', window.innerWidth >= 768);
        };
        window.addEventListener('resize', handleResize);
        console.log('Initial sidebar state:', sidebarOpen);
        return () => window.addEventListener('resize', handleResize);
      }, []);

      useEffect(() => {
        localStorage.setItem('theme', theme);
        console.log('Theme saved to localStorage:', theme);
      }, [theme]);

      useEffect(() => {
        console.log('Fetching disasters.json');
        fetch('/static/disasters.json')
          .then(response => {
            console.log('Fetch response status:', response.status);
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}, URL: ${response.url}`);
            return response.json();
          })
          .then(data => {
            console.log('Data fetched, length:', data.length);
            if (!Array.isArray(data) || data.length === 0) {
              setError('Invalid or empty data received from disasters.json');
              return;
            }
            setRawData(data);
            const uniqueCountries = ['All', ...new Set(data.map(d => d.Country).filter(Boolean))].sort();
            const uniqueYears = ['All', ...new Set(data.map(d => d['Start Year']).filter(Boolean))].sort((a, b) => a - b);
            console.log('Unique countries:', uniqueCountries.length, 'Unique years:', uniqueYears.length);
            setCountries(uniqueCountries);
            setYears(uniqueYears);
            const processedData = processData(data, selectedCountry, selectedYear);
            if (processedData) {
              setData(processedData);
            } else {
              setError('Failed to process initial data');
            }
          })
          .catch(error => {
            console.error('Fetch error:', error.message, error.stack);
            setError(`Failed to load data: ${error.message}`);
          });
      }, []);

      useEffect(() => {
        if (rawData) {
          console.log('Reprocessing data for country:', selectedCountry, 'year:', selectedYear);
          try {
            const processedData = processData(rawData, selectedCountry, selectedYear);
            if (processedData) {
              setData(processedData);
              setError(null);
            } else {
              setError('No data available for selected filters');
            }
          } catch (error) {
            console.error('Error reprocessing data:', error.message, error.stack);
            setError('Failed to process data for selected filters');
          }
        }
      }, [selectedCountry, selectedYear, rawData]);

      useEffect(() => {
        if (!data) {
          console.log('No data to render charts');
          return;
        }

        console.log('Initializing charts, showLabels:', showLabels, 'Theme:', theme);
        console.log('Gradient animation settings: duration 5s, size 600%, colors:', theme === 'dark' ? '[#330000, #4c1d95, #990000, #d97706, #cc6600]' : '[#ff66b2, #a3e635, #66b2ff, #ff6b6b, #cc66ff]');

        const chartOptions = {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                font: { size: 12 },
                display: showLabels,
                filter: (legendItem, chartData) => {
                  const dataset = chartData.datasets[0];
                  const total = dataset.data.reduce((sum, val) => sum + val, 0);
                  const value = dataset.data[legendItem.index];
                  return value / total >= 0.1;
                }
              },
              onClick: (e, legendItem, legend) => {
                const index = legendItem.datasetIndex;
                const ci = legend.chart;
                ci.getDatasetMeta(index).hidden = !ci.getDatasetMeta(index).hidden;
                ci.update();
              }
            },
            tooltip: { enabled: true, padding: 10 },
            zoom: {
              zoom: {
                wheel: { enabled: true },
                pinch: { enabled: true },
                mode: 'xy'
              },
              pan: {
                enabled: true,
                mode: 'xy'
              }
            }
          },
          animation: {
            duration: 1200,
            onComplete: () => console.log('Chart animation complete')
          }
        };

        // Chart colors
        const chartColors = theme === 'dark' ? {
          trends: '#dc2626',
          types: ['#ff4d4d', '#ff8c00', '#ffd700', '#32cd32', '#1e90ff', '#d8bfd8', '#ff69b4', '#20b2aa', '#ff4040', '#ff1493'],
          locations: '#ea580c',
          impact: ['#dc2626', '#ea580c'],
          deadliest: '#fb923c',
          damage: '#f87171',
          seasonality: '#dc2626',
          correlation: '#ea580c',
          regions: '#f43f5e',
          damageYear: '#fb7185',
          subtypes: '#22d3ee'
        } : {
          trends: '#059669',
          types: ['#00ff7f', '#7fffd4', '#ffd700', '#ff4500', '#4169e1', '#dda0dd', '#ff69b4', '#00ced1', '#98fb98', '#87ceeb'],
          locations: '#1e40af',
          impact: ['#059669', '#1e40af'],
          deadliest: '#34d399',
          damage: '#6ee7b7',
          seasonality: '#059669',
          correlation: '#1e40af',
          regions: '#22d3ee',
          damageYear: '#60a5fa',
          subtypes: '#22d3ee'
        };

        // Destroy existing charts
        const destroyChart = (ref) => {
          if (ref.current && ref.current.chart) {
            console.log(`Destroying chart: ${ref.current.id || 'unknown'}`);
            ref.current.chart.destroy();
            ref.current.chart = null;
          }
        };

        // Top Disaster Types (Pie Chart)
        destroyChart(typesChartRef);
        if (typesChartRef.current) {
          console.log('Rendering typesChart');
          try {
            typesChartRef.current.chart = new Chart(typesChartRef.current, {
              type: 'pie',
              data: {
                labels: Object.keys(data.disasterTypes),
                datasets: [{
                  data: Object.values(data.disasterTypes),
                  backgroundColor: chartColors.types
                }]
              },
              options: {
                ...chartOptions,
                maintainAspectRatio: false
              }
            });
          } catch (error) {
            console.error('Error rendering typesChart:', error.message, error.stack);
          }
        }

        // Disaster Trends Over Time
        destroyChart(trendsChartRef);
        if (trendsChartRef.current) {
          console.log('Rendering trendsChart');
          try {
            trendsChartRef.current.chart = new Chart(trendsChartRef.current, {
              type: 'line',
              data: {
                labels: Object.keys(data.disastersPerYear),
                datasets: [{
                  label: 'Disasters per Year',
                  data: Object.values(data.disastersPerYear),
                  borderColor: chartColors.trends,
                  backgroundColor: chartColors.trends,
                  tension: 0.4
                }]
              },
              options: chartOptions
            });
          } catch (error) {
            console.error('Error rendering trendsChart:', error.message, error.stack);
          }
        }

        // Most Affected Locations
        destroyChart(locationsChartRef);
        if (locationsChartRef.current) {
          console.log('Rendering locationsChart');
          try {
            locationsChartRef.current.chart = new Chart(locationsChartRef.current, {
              type: 'bar',
              data: {
                labels: Object.keys(data.locations),
                datasets: [{
                  label: 'Disaster Count',
                  data: Object.values(data.locations),
                  backgroundColor: chartColors.locations
                }]
              },
              options: chartOptions
            });
          } catch (error) {
            console.error('Error rendering locationsChart:', error.message, error.stack);
          }
        }

        // Impact by Disaster Type
        destroyChart(impactChartRef);
        if (impactChartRef.current) {
          console.log('Rendering impactChart');
          try {
            impactChartRef.current.chart = new Chart(impactChartRef.current, {
              type: 'bar',
              data: {
                labels: Object.keys(data.impactByType),
                datasets: [
                  {
                    label: 'Total Deaths',
                    data: Object.values(data.impactByType).map(d => d.deaths),
                    backgroundColor: chartColors.impact[0]
                  },
                  {
                    label: 'Total Affected',
                    data: Object.values(data.impactByType).map(d => d.affected),
                    backgroundColor: chartColors.impact[1]
                  }
                ]
              },
              options: { ...chartOptions, scales: { x: { stacked: true }, y: { stacked: true } } }
            });
          } catch (error) {
            console.error('Error rendering impactChart:', error.message, error.stack);
          }
        }

        // Deadliest Years
        destroyChart(deadliestChartRef);
        if (deadliestChartRef.current) {
          console.log('Rendering deadliestChart');
          try {
            deadliestChartRef.current.chart = new Chart(deadliestChartRef.current, {
              type: 'bar',
              data: {
                labels: Object.keys(data.deathsByYear),
                datasets: [{
                  label: 'Total Deaths',
                  data: Object.values(data.deathsByYear),
                  backgroundColor: chartColors.deadliest
                }]
              },
              options: chartOptions
            });
          } catch (error) {
            console.error('Error rendering deadliestChart:', error.message, error.stack);
          }
        }

        // Most Destructive Disaster Types
        destroyChart(damageChartRef);
        if (damageChartRef.current) {
          console.log('Rendering damageChart');
          try {
            damageChartRef.current.chart = new Chart(damageChartRef.current, {
              type: 'bar',
              data: {
                labels: Object.keys(data.damageByType),
                datasets: [{
                  label: "Total Damage ('000 US$)",
                  data: Object.values(data.damageByType),
                  backgroundColor: chartColors.damage
                }]
              },
              options: chartOptions
            });
          } catch (error) {
            console.error('Error rendering damageChart:', error.message, error.stack);
          }
        }

        // Seasonality of Disasters
        destroyChart(seasonalityChartRef);
        if (seasonalityChartRef.current) {
          console.log('Rendering seasonalityChart');
          try {
            seasonalityChartRef.current.chart = new Chart(seasonalityChartRef.current, {
              type: 'line',
              data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                datasets: [{
                  label: 'Disasters per Month',
                  data: data.disastersPerMonth,
                  borderColor: chartColors.seasonality,
                  backgroundColor: chartColors.seasonality,
                  tension: 0.4
                }]
              },
              options: chartOptions
            });
          } catch (error) {
            console.error('Error rendering seasonalityChart:', error.message, error.stack);
          }
        }

        // Correlation Analysis
        destroyChart(correlationChartRef);
        if (correlationChartRef.current) {
          console.log('Rendering correlationChart');
          try {
            correlationChartRef.current.chart = new Chart(correlationChartRef.current, {
              type: 'scatter',
              data: {
                datasets: [{
                  label: 'Deaths vs. Damage',
                  data: data.correlationData,
                  backgroundColor: chartColors.correlation
                }]
              },
              options: {
                ...chartOptions,
                scales: {
                  x: { title: { display: true, text: 'Total Deaths' } },
                  y: { title: { display: true, text: "Total Damage ('000 US$)" } }
                }
              }
            });
          } catch (error) {
            console.error('Error rendering correlationChart:', error.message, error.stack);
          }
        }

        // Disaster Frequency by Region
        destroyChart(regionsChartRef);
        if (regionsChartRef.current) {
          console.log('Rendering regionsChart');
          try {
            regionsChartRef.current.chart = new Chart(regionsChartRef.current, {
              type: 'bar',
              data: {
                labels: Object.keys(data.regions),
                datasets: [{
                  label: 'Disaster Count',
                  data: Object.values(data.regions),
                  backgroundColor: chartColors.regions
                }]
              },
              options: chartOptions
            });
          } catch (error) {
            console.error('Error rendering regionsChart:', error.message, error.stack);
          }
        }

        // Economic Impact by Year
        destroyChart(damageYearChartRef);
        if (damageYearChartRef.current) {
          console.log('Rendering damageYearChart');
          try {
            damageYearChartRef.current.chart = new Chart(damageYearChartRef.current, {
              type: 'bar',
              data: {
                labels: Object.keys(data.damageByYear),
                datasets: [{
                  label: "Total Damage ('000 US$)",
                  data: Object.values(data.damageByYear),
                  backgroundColor: chartColors.damageYear
                }]
              },
              options: chartOptions
            });
          } catch (error) {
            console.error('Error rendering damageYearChart:', error.message, error.stack);
          }
        }

        // Disaster Frequency by Subtype or Top 5 Costliest Disasters
        destroyChart(subtypesChartRef);
        if (subtypesChartRef.current) {
          console.log('Rendering subtypesChart');
          try {
            subtypesChartRef.current.chart = new Chart(subtypesChartRef.current, {
              type: 'bar',
              data: {
                labels: data.subtypes && Object.keys(data.subtypes).length > 0
                  ? Object.keys(data.subtypes)
                  : data.costliestDisasters.map(d => d.label),
                datasets: [{
                  label: data.subtypes && Object.keys(data.subtypes).length > 0
                    ? 'Disaster Count'
                    : "Total Damage ('000 US$)",
                  data: data.subtypes && Object.keys(data.subtypes).length > 0
                    ? Object.values(data.subtypes)
                    : data.costliestDisasters.map(d => d.damage),
                  backgroundColor: chartColors.subtypes
                }]
              },
              options: chartOptions
            });
          } catch (error) {
            console.error('Error rendering subtypesChart:', error.message, error.stack);
          }
        }

        // Cleanup on unmount
        return () => {
          destroyChart(trendsChartRef);
          destroyChart(typesChartRef);
          destroyChart(locationsChartRef);
          destroyChart(impactChartRef);
          destroyChart(deadliestChartRef);
          destroyChart(damageChartRef);
          destroyChart(seasonalityChartRef);
          destroyChart(correlationChartRef);
          destroyChart(regionsChartRef);
          destroyChart(damageYearChartRef);
          destroyChart(subtypesChartRef);
        };
      }, [data, theme, showLabels]);

      // Guided tour steps
      const tourSteps = [
        {
          title: 'Welcome to AI-DMS Dashboard',
          description: 'This dashboard provides insights into disasters in Asia from 2000–2025. Let’s explore its features!',
          target: null
        },
        {
          title: 'Sidebar Navigation',
          description: 'Use the sidebar to jump to charts, toggle labels, restart the tour, or return home.',
          target: '.sidebar'
        },
        {
          title: 'Filter Section',
          description: 'Select a country or year to filter the data, reset filters, or download data.',
          target: '.filter-box'
        },
        {
          title: 'Interactive Charts',
          description: 'Zoom and pan charts to explore data in detail. Hover for tooltips with additional information.',
          target: '.card-types'
        },
        {
          title: 'Insights Section',
          description: 'Learn about each chart’s purpose and use cases by expanding the cards below.',
          target: '.insights-box'
        }
      ];

      // Explanations for charts with icons and use cases
      const explanations = [
        {
          title: 'Top Disaster Types',
          description: 'This pie chart illustrates the frequency of disaster types (e.g., Flood, Storm) in the selected country, grouping minor categories (<5%) into "Other". It highlights dominant hazards, aiding in targeted mitigation strategies.',
          useCase: 'Policy Planning',
          iconPath: 'M5 11.5a3.5 3.5 0 100-7 3.5 3.5 0 000 7zm0 1a4.5 4.5 0 110-9 4.5 4.5 0 010 9zM19 8.5a3.5 3.5 0 100-7 3.5 3.5 0 000 7zm0 1a4.5 4.5 0 110-9 4.5 4.5 0 010 9zM12 19.5a3.5 3.5 0 100-7 3.5 3.5 0 000 7zm0 1a4.5 4.5 0 110-9 4.5 4.5 0 0118 0z'
        },
        {
          title: 'Disaster Trends Over Time',
          description: 'A line chart showing the number of disasters per year from 2000 to 2025. It reveals temporal trends, such as increasing or decreasing disaster frequency, and identifies peak years.',
          useCase: 'Research & Forecasting',
          iconPath: 'M3 12h18m-14 4h10m-10-8h14'
        },
        {
          title: 'Most Affected Locations',
          description: 'This bar chart displays the top 10 countries by disaster count when "All" is selected, or focuses on the selected country’s data. It helps identify high-risk areas.',
          useCase: 'Regional Planning',
          iconPath: 'M3 4h18v16H3V4zm2 2v12h14V6H5z'
        },
        {
          title: 'Impact by Disaster Type',
          description: 'A stacked bar chart comparing total deaths and affected populations by disaster type. It quantifies human impact, revealing which disasters cause the most harm.',
          useCase: 'Humanitarian Aid',
          iconPath: 'M5 3h14v18H5V3zm2 2v14h10V5H7z'
        },
        {
          title: 'Top 5 Deadliest Years',
          description: 'This bar chart highlights the five years with the highest total deaths, pinpointing significant disaster events.',
          useCase: 'Historical Analysis',
          iconPath: 'M4 4h16v16H4V4zm2 2v12h12V6H6z'
        },
        {
          title: 'Disaster Types by Economic Loss',
          description: 'A bar chart showing economic damage by disaster type, measured in thousands of US dollars. It identifies the costliest hazards.',
          useCase: 'Financial Planning',
          iconPath: 'M3 3h18v18H3V3zm2 2v14h14V5H5z'
        },
        {
          title: 'Seasonality of Disasters',
          description: 'A line chart plotting disaster frequency by month, revealing seasonal patterns (e.g., monsoon-related floods in July–August).',
          useCase: 'Seasonal Preparedness',
          iconPath: 'M12 4v16m-8-8h16'
        },
        {
          title: 'Deaths vs. Economic Damage',
          description: 'A scatter plot correlating total deaths with economic damage per disaster event. It explores whether high human toll aligns with financial loss.',
          useCase: 'Risk Assessment',
          iconPath: 'M6 6l12 12m0-12L6 18'
        },
        {
          title: 'Disaster Frequency by Region',
          description: 'This bar chart shows disaster counts by region (e.g., South Asia, East Asia), highlighting regional vulnerabilities.',
          useCase: 'International Coordination',
          iconPath: 'M3 12h18M12 3v18'
        },
        {
          title: 'Economic Impact by Year',
          description: 'A bar chart displaying total economic damage per year, identifying high-cost years.',
          useCase: 'Budget Planning',
          iconPath: 'M5 3h14v18H5V3zm2 2v14h10V5H7z'
        },
        {
          title: data && data.subtypes && Object.keys(data.subtypes).length > 0
            ? 'Disaster Frequency by Subtype'
            : 'Top 5 Costliest Disasters',
          description: data && data.subtypes && Object.keys(data.subtypes).length > 0
            ? 'This bar chart shows the frequency of disaster subtypes (e.g., Tropical Cyclone, Riverine Flood), offering a detailed hazard breakdown.'
            : 'This bar chart lists the five disasters with the highest economic damage, detailing type, year, and country.',
          useCase: data && data.subtypes && Object.keys(data.subtypes).length > 0
            ? 'Specialized Mitigation'
            : 'Case Studies',
          iconPath: 'M4 4h16v16H4V4zm2 2v12h12V6H6z'
        }
      ];

      // Explanation Card Component
      const ExplanationCard = ({ exp, index }) => {
        const [isOpen, setIsOpen] = useState(false);
        const copyToClipboard = () => {
          navigator.clipboard.write(exp.description);
          console.log(`Copied description: ${exp.title}`);
          alert(`Copied: ${exp.description}`);
        };
        return (
          <div className={`card card-explanation ${isOpen ? 'expanded' : ''} w-full`}>
            <div className="flex items-center justify-between p-4">
              <div className="flex items-center space-x-3">
                <svg className="w-6 h-6 text-current" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d={exp.iconPath} />
                </svg>
                <h3 className="text-lg font-semibold">{exp.title}</h3>
              </div>
              <button
                onClick={() => {
                  setIsOpen(!isOpen);
                  console.log(`Toggled card: ${exp.title}, isOpen: ${!isOpen}`);
                }}
              >
                {isOpen ? (
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20 12H4" />
                  </svg>
                ) : (
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4v16m8-8H4" />
                  </svg>
                )}
              </button>
            </div>
            <div className={`explanation-content p-4 overflow-hidden ${isOpen ? 'opacity-100' : 'opacity-0 h-0'}`}>
              <p className="text-base mb-2">{exp.description}</p>
              <p className="text-sm">Use Case: {exp.useCase}</p>
              <button
                className={`mt-2 p-2 rounded-lg text-white text-sm ${theme === 'dark' ? 'bg-gradient-to-r from-red-600 to-yellow-400' : 'bg-gradient-to-r from-purple-600 to-pink-500'}`}
                onClick={copyToClipboard}
              >
                Copy Description
              </button>
            </div>
          </div>
        );
      };

      // Guided Tour Modal Component
      const TourModal = () => {
        if (!showTour) return null;
        const step = tourSteps[tourStep];
        const isLastStep = tourStep === tourSteps.length - 1;

        const handleNext = () => {
          if (isLastStep) {
            setShowTour(false);
            localStorage.setItem('tourCompleted', 'true');
            console.log('Tour completed');
          } else {
            setTourStep(tourStep + 1);
            console.log('Tour step:', tourStep + 1);
            if (step.target) {
              const target = document.querySelector(step.target);
              if (target) target.scrollIntoView({ behavior: 'smooth' });
            }
          }
        };

        const handleSkip = () => {
          setShowTour(false);
          localStorage.setItem('tourCompleted', 'true');
          console.log('Tour skipped');
        };

        return (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div className={`bg-white rounded-lg p-6 max-w-md ${theme === 'dark' ? 'bg-gray-800 text-white' : 'text-gray-800'}`}>
              <h3 className="text-xl font-bold mb-4">{step.title}</h3>
              <p className="mb-6">{step.description}</p>
              <div className="flex justify-between">
                <button
                  className="p-2 rounded-lg bg-gray-300 text-gray-800"
                  onClick={handleSkip}
                >
                  Skip Tour
                </button>
                <button
                  className={`p-2 rounded-lg ${theme === 'dark' ? 'bg-gradient-to-r from-red-600 to-yellow-400' : 'bg-gradient-to-r from-green-500 to-lime-400'} text-white`}
                  onClick={handleNext}
                >
                  {isLastStep ? 'Finish' : 'Next'}
                </button>
              </div>
            </div>
          </div>
        );
      };

      // Button click handler with feedback
      const handleButtonClick = (action, buttonType) => {
        setBtnActive(buttonType);
        setTimeout(() => setBtnActive(''), 300);
        action();
      };

      // Data properties for info boxes with icons
      const dataProperties = rawData ? [
        {
          title: 'Number of Countries',
          value: new Set(rawData.map(d => d.Country).filter(Boolean)).size,
          iconColor: theme === 'dark' ? '#ff4d4d' : '#f43f5e',
          iconPath: 'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm0-14c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6z'
        },
        {
          title: 'Number of Years',
          value: `${Math.min(...rawData.map(d => d['Start Year']).filter(Boolean))}–${Math.max(...rawData.map(d => d['Start Year']).filter(Boolean))}`,
          iconColor: theme === 'dark' ? '#ffd700' : '#22d3ee',
          iconPath: 'M6 2v2h2V2H6zm4 0v2h2V2h-2zm4 0v2h2V2h-2zm4 0v2h2V2h-2zm0 4h-2v2h2V6zm0 4h-2v2h2v-2zm0 4h-2v2h2v-2zm0 4h-2v2h2v-2zm-4 0v2h2v-2h-2zm-4 0v2h2v-2h-2zm-4 0v2h2v-2H6zm-4-4h2v2H2v-2zm0-4h2v2H2v-2zm0-4h2v2H2V6zm4-4v2h2V2H6z'
        },
        {
          title: 'Number of Disasters',
          value: rawData.length,
          iconColor: theme === 'dark' ? '#32cd32' : '#facc15',
          iconPath: 'M12 2L1 21h22L12 2zm0 3.24L19.76 18H4.24L12 5.24z'
        }
      ] : [];

      if (error) return <div className="text-center text-xl mt-10 text-red-400">Error: {error}</div>;
      if (!data) return <div className="text-center text-xl mt-10 text-gray-200">Loading...</div>;
      if (Object.keys(data.disastersPerYear).length === 0) return <div className="text-center text-xl mt-10 text-red-400">No data available for selected filters</div>;

      console.log('Rendering Dashboard component, theme:', theme, 'showLabels:', showLabels, 'showTour:', showTour, 'sidebarOpen:', sidebarOpen);

      return (
        <div className={`min-h-screen flex ${theme === 'dark' ? 'theme-dark' : 'theme-green'}`}>
          <TourModal />
          {/* Sidebar (20%) */}
          <div className={`sidebar w-1/5 ${theme === 'dark' ? 'bg-gradient-to-r from-red-900 to-black' : 'bg-gradient-to-r from-blue-400 to-blue-800'} p-4 flex flex-col justify-between ${sidebarOpen ? 'sidebar-open' : 'sidebar-hidden'} fixed top-0 h-full z-50 md:static md:block`}>
            <div className="overflow-y-auto max-h-[100vh]">
              {/* Logo */}
              <div className="mb-4 flex items-center justify-center space-x-2">
                <h1 className={`text-2xl font-extrabold ${theme === 'dark' ? 'text-white' : 'text-white'} transition-transform duration-200 hover:scale-105`} style={{ textShadow: '0 0 5px rgba(255, 255, 255, 0.5)' }}>AI-DMS</h1>
                <img src="/static/img/Planet Earth Spinning Sticker by namslam.gif" alt="Spinning Earth" className="w-8 h-8" />
                </div>
              {/* Avatar and Name */}
              <div className="flex flex-col items-center mb-4">
                <div className={`w-24 h-24 rounded-full flex items-center justify-center opacity-100 shadow-lg ring-2 ring-opacity-50 ${theme === 'dark' ? 'bg-gradient-to-br from-red-600 to-black border-4 border-red-300 ring-red-200' : 'bg-gradient-to-br from-blue-700 to-blue-800 border-4 border-blue-300 ring-blue-200'}`}>
                  <span className="text-4xl font-bold text-white" style={{ textShadow: '1px 1px 2px rgba(0,0,0,0.3)' }}>J</span>
                </div>
                <p className={`mt-2 text-lg font-bold ${theme === 'dark' ? 'text-white' : 'text-white'}`}>John</p>
              </div>
              <div className="flex justify-between items-center mb-4">
                <h3 className={`text-lg font-semibold ${theme === 'dark' ? 'text-white' : 'text-white'}`}>Quick Navigation</h3>
                <button
                  className="md:hidden p-2 rounded-lg"
                  onClick={() => setSidebarOpen(false)}
                >
                  <svg className={`w-6 h-6 ${theme === 'dark' ? 'text-white' : 'text-white'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
              <ul className="space-y-2">
                {explanations.map((exp, index) => (
                  <li key={index}>
                    <button
                      className={`w-full text-left p-2 rounded-lg flex items-center space-x-2 transition-colors duration-200 ${theme === 'dark' ? 'text-white hover:bg-red-600' : 'text-white hover:bg-blue-700'}`}
                      onClick={() => {
                        const sectionKey = Object.keys(sections).find(key => exp.title.toLowerCase().includes(key));
                        if (sectionKey && sections[sectionKey].current) {
                          sections[sectionKey].current.scrollIntoView({ behavior: 'smooth' });
                          console.log(`Navigated to section: ${sectionKey}`);
                          setSidebarOpen(false);
                        }
                      }}
                    >
                      <svg className={`w-5 h-5 ${theme === 'dark' ? 'text-white' : 'text-white'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d={exp.iconPath} />
                      </svg>
                      <span>{exp.title}</span>
                    </button>
                  </li>
                ))}
                <li>
                  <button
                    className={`w-full text-left p-2 rounded-lg flex items-center space-x-2 transition-colors duration-200 ${theme === 'dark' ? 'text-white hover:bg-red-600' : 'text-white hover:bg-blue-700'}`}
                    onClick={() => {
                      setShowTour(true);
                      setTourStep(0);
                      console.log('Restarted tour');
                      setSidebarOpen(false);
                    }}
                  >
                    <svg className={`w-5 h-5 ${theme === 'dark' ? 'text-white' : 'text-white'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h5m0 0l-7 7m7-7V4m11 0v16a2 2 0 01-2 2H6a2 2 0 01-2-2V8" />
                    </svg>
                    <span>Restart Tour</span>
                  </button>
                </li>
                <li>
                  <button
                    className={`w-full text-left p-2 rounded-lg labels-btn ${btnActive === 'labels' ? 'btn-active' : ''} flex items-center space-x-2 transition-colors duration-200 ${theme === 'dark' ? 'text-white hover:bg-red-600' : 'text-white hover:bg-blue-700'}`}
                    onClick={() => handleButtonClick(() => {
                      setShowLabels(!showLabels);
                      console.log('Toggled chart labels:', !showLabels);
                      setSidebarOpen(false);
                    }, 'labels')}
                  >
                    <svg className={`w-5 h-5 ${theme === 'dark' ? 'text-white' : 'text-white'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                    </svg>
                    <span>{showLabels ? 'Hide Labels' : 'Show Labels'}</span>
                  </button>
                </li>
                <li>
                  <a
                    href="{{ url_for('home') }}"
                    className={`w-full text-left p-2 rounded-lg home-btn flex items-center space-x-2 transition-colors duration-200 ${theme === 'dark' ? 'text-white hover:bg-red-600' : 'text-white hover:bg-blue-700'}`}
                    onClick={() => {
                      console.log('Navigating to home');
                      setSidebarOpen(false);
                    }}
                  >
                    <svg className={`w-5 h-5 ${theme === 'dark' ? 'text-white' : 'text-white'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                    <span>Back to Home</span>
                  </a>
                </li>
              </ul>
            </div>
          </div>
          {/* Main Content (80%) */}
          <div className="main-content w-4/5 ml-[20%]">
            {/* Header */}
            <div className={`header fixed top-0 left-[20%] right-0 p-4 flex items-center justify-between shadow-md z-40 ${theme === 'dark' ? 'bg-gradient-to-r from-black via-red-600' : 'bg-gradient-to-r from-gray-900 to-indigo-600'}`}>
              <div className="flex items-center space-x-4">
                <button
                  className={`p-2 rounded-lg ${theme === 'dark' ? 'bg-gray-700' : 'bg-gray-200'}`}
                  onClick={() => setSidebarOpen(!sidebarOpen)}
                >
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16" />
                  </svg>
                </button>
              </div>
              <div className="flex items-center space-x-4">
                <div className="flex items-center space-x-2">
                  <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <span className="text-white text-sm">{currentTime}</span>
                </div>
                <div className="flex items-center space-x-2">
                  <div className={`w-8 h-8 rounded-full flex items-center justify-center ${theme === 'dark' ? 'bg-gradient-to-br from-indigo-600 to-purple-500' : 'bg-gradient-to-br from-emerald-600 to-teal-500'}`}>
                    <span className="text-lg font-bold text-white">J</span>
                  </div>
                </div>
                <button
                  className="p-2 rounded-lg theme-btn"
                  onClick={() => {
                    setTheme(theme === 'dark' ? 'green' : 'dark');
                    console.log('Theme switched to:', theme === 'dark' ? 'green' : 'dark');
                  }}
                >
                  {theme === 'dark' ? (
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" className="w-6 h-6 text-white">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                  ) : (
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" className="w-6 h-6 text-white">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                  )}
                </button>
              </div>
            </div>
            {/* Welcome Section */}
            <div className="pt-24 px-4">
              <div className="glass-box rounded-xl p-6 shadow-lg max-w-[95%] mx-auto">
                <h2 className={`text-2xl font-bold mb-2 ${theme === 'dark' ? 'text-white' : 'text-gray-800'}`}>Welcome to Dashboard</h2>
                <p className={`text-lg ${theme === 'dark' ? 'text-gray-200' : 'text-gray-600'}`}>Hello John Doe, welcome to your awesome dashboard!</p>
              </div>
              {/* Info Boxes */}
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6 max-w-[95%] mx-auto">
                {dataProperties.map((prop, index) => (
                  <div key={index} className="glass-box rounded-xl p-4 shadow-lg flex items-center">
                    <svg className="w-12 h-12 mr-4" fill={prop.iconColor} viewBox="0 0 24 24">
                      <path d={prop.iconPath} />
                    </svg>
                    <div>
                      <p className={`text-lg font-semibold ${theme === 'dark' ? 'text-white' : 'text-gray-800'}`}>{prop.title}</p>
                      <p className={`text-2xl font-bold ${theme === 'dark' ? 'text-white' : 'text-gray-800'}`}>{prop.value}</p>
                    </div>
                  </div>
                ))}
              </div>
              {/* Filter Section */}
              <div className="filter-box glass-box rounded-xl p-4 shadow-lg mt-6 max-w-4xl mx-auto flex justify-center gap-4">
                <div className="relative group">
                  <select
                    className="p-2 rounded-lg bg-white text-gray-800 border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400"
                    value={selectedCountry}
                    onChange={(e) => {
                      console.log('Country selected:', e.target.value);
                      setSelectedCountry(e.target.value);
                    }}
                  >
                    {countries.map(country => (
                      <option key={country} value={country}>{country}</option>
                    ))}
                  </select>
                  <div className="tooltip absolute -top-10 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-sm rounded p-2">
                    Choose a country to filter data
                  </div>
                </div>
                <div className="relative group">
                  <select
                    className="p-2 rounded-lg bg-white text-gray-800 border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400"
                    value={selectedYear}
                    onChange={(e) => {
                      console.log('Year selected:', e.target.value);
                      setSelectedYear(e.target.value);
                    }}
                  >
                    {years.map(year => (
                      <option key={year} value={year}>{year}</option>
                    ))}
                  </select>
                  <div className="tooltip absolute -top-10 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-sm rounded p-2">
                    Choose a year to filter data
                  </div>
                </div>
                <button
                  className={`p-2 rounded-lg filter-btn text-sm ${btnActive === 'reset' ? 'btn-active' : ''} ${theme === 'dark' ? 'bg-gradient-to-r from-red-600 to-yellow-400' : 'bg-gradient-to-r from-green-500 to-lime-400'} text-white`}
                  onClick={() => handleButtonClick(() => {
                    console.log('Reset filter clicked');
                    setSelectedCountry('All');
                    setSelectedYear('All');
                  }, 'reset')}
                >
                  Reset Filter
                </button>
                <button
                  className={`p-2 rounded-lg download-btn text-sm ${btnActive === 'download' ? 'btn-active' : ''} ${theme === 'dark' ? 'bg-gradient-to-r from-red-600 to-yellow-400' : 'bg-gradient-to-r from-green-500 to-lime-400'} text-white`}
                  onClick={() => handleButtonClick(() => {
                    console.log('Download data clicked');
                    alert('Download functionality not implemented yet');
                  }, 'download')}
                >
                  Download Data
                </button>
              </div>
              {/* Charts and Insights */}
              <div className="space-y-10 mt-8">
                <div className="flex flex-col md:flex-row gap-8" ref={sections.types}>
                  <div className="card card-types w-full md:w-2/5 h-144">
                    <div className="card-header">Top Disaster Types</div>
                    <div className="p-4">
                      <canvas ref={typesChartRef} height="400"></canvas>
                    </div>
                  </div>
                  <div className="card card-trends w-full md:w-3/5 h-144" ref={sections.trends}>
                    <div className="card-header">Disaster Trends Over Time</div>
                    <div className="p-6">
                      <canvas ref={trendsChartRef}></canvas>
                    </div>
                  </div>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                  <div className="card card-locations h-112" ref={sections.locations}>
                    <div className="card-header">Most Affected Locations</div>
                    <div className="p-4">
                      <canvas ref={locationsChartRef} height="350"></canvas>
                    </div>
                  </div>
                  <div className="card card-impact h-112" ref={sections.impact}>
                    <div className="card-header">Impact by Disaster Type</div>
                    <div className="p-4">
                      <canvas ref={impactChartRef} height="350"></canvas>
                    </div>
                  </div>
                  <div className="card card-deadliest h-112" ref={sections.deadliest}>
                    <div className="card-header">Top 5 Deadliest Years</div>
                    <div className="p-4">
                      <canvas ref={deadliestChartRef} height="350"></canvas>
                    </div>
                  </div>
                  <div className="card card-damage h-112" ref={sections.damage}>
                    <div className="card-header">Disaster Types by Economic Loss</div>
                    <div className="p-4">
                      <canvas ref={damageChartRef} height="350"></canvas>
                    </div>
                  </div>
                  <div className="card card-seasonality h-112" ref={sections.seasonality}>
                    <div className="card-header">Seasonality of Disasters</div>
                    <div className="p-4">
                      <canvas ref={seasonalityChartRef} height="350"></canvas>
                    </div>
                  </div>
                  <div className="card card-correlation h-112" ref={sections.correlation}>
                    <div className="card-header">Deaths vs. Economic Damage</div>
                    <div className="p-4">
                      <canvas ref={correlationChartRef} height="350"></canvas>
                    </div>
                  </div>
                  <div className="card card-regions h-112" ref={sections.regions}>
                    <div className="card-header">Disaster Frequency by Region</div>
                    <div className="p-4">
                      <canvas ref={regionsChartRef} height="350"></canvas>
                    </div>
                  </div>
                  <div className="card card-damage-year h-112" ref={sections.damageYear}>
                    <div className="card-header">Economic Impact by Year</div>
                    <div className="p-4">
                      <canvas ref={damageYearChartRef} height="350"></canvas>
                    </div>
                  </div>
                  <div className="card card-subtypes h-112" ref={sections.subtypes}>
                    <div className="card-header">
                      {data.subtypes && Object.keys(data.subtypes).length > 0
                        ? 'Disaster Frequency by Subtype'
                        : 'Top 5 Costliest Disasters'}
                    </div>
                    <div className="p-4">
                      <canvas ref={subtypesChartRef} height="350"></canvas>
                    </div>
                  </div>
                </div>
                {/* Insights Section */}
                <div className="insights-box mt-12 max-w-[95%] mx-auto" ref={sections.insights}>
                  <h2 className={`text-3xl font-bold text-center py-4 shadow-lg ${theme === 'dark' ? 'text-white' : 'text-gray-800'}`}>Understanding Insights</h2>
                  <div className="explanation-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 w-full">
                    {explanations.map((exp, index) => (
                      <ExplanationCard key={index} exp={exp} index={index} />
                    ))}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // Render the Dashboard component
    ReactDOM.render(<Dashboard />, document.getElementById('root'));
    console.log('ReactDOM rendered Dashboard component');
  </script>
  {% endraw %}
</body>
</html>